@model ReservaSalas.Models.Reservas
@using ReservaSalas.Extensions
@{
    string cdn = Config.GetConfig("URL:CDN");
    string controller = @Model.ControllerName;
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
}

@{
    ViewData["Title"] = "Edit";

    if (Model.TypeView == TypeView.None)
    {
        Layout = "~/Views/Shared/_Layout.cshtml";

        <div id='div_breadcrumbs' class='mb-3'>
            <ol class='tbreadcrumb'>
                <li>
                    <a asp-action="Default" asp-controller="Home">
                        <span><i class='fas fa-home'></i> Início</span>
                    </a>
                </li>
                <li>
                    <a asp-action="Index">
                        <span> Gerenciar Reservas</span>
                    </a>
                </li>
                <li>
                    <span> Alterar dados doReservas</span>
                </li>
            </ol>
        </div>

        <div class="app-title mb-4">
            <div>
                <h1><i class="fa fa-dashboard"></i>Gerenciar Reservas</h1>
                <p>Alterar dados do Reservas</p>
            </div>
        </div>
    }
}

@Html.Raw(TempData["alert"])

@if (Model.TypeView == TypeView.None)
{
    @Html.Raw("<form method=\"post\" asp-action=\"Edit\" asp-controller=\"@controller\" class=\"needs-validation\" novalidate id=\"defaultForm\">")
}


<div asp-validation-summary="ModelOnly" class="text-danger"></div>
<input type="hidden" asp-for="SqReserva" />
<input type="hidden" asp-for="IdUsuarioCriador" />
<input type="hidden" asp-for="IndValidado" />
<fieldset class="fieldset-form">
    <legend class='mb-2'>Informações</legend>
    <div class="row">
        <div class="col-12">
            <div class="txtInfo mb-3">
                <strong>
                    <label asp-for="SqSala" class="control-label">Sala: </label>
                </strong>
                @Html.DropDownListFor(model => model.SqSala, new SelectList(Model.SalasDropDownList.Where(x => x.IndAtivo == 1), "Id", "Nome"), "- Selecione -", new { @class = "select-disabled reservas-edit select-obrigatorio", disabled = "disabled" })
                @Html.DropDownListFor(model => model.SqSala, new SelectList(Model.SalasDropDownList.Where(x => x.IndAtivo == 1), "Id", "CapacidadeSala"), "- Selecione -", new { @class = "select form-control form-control-sm reservas-create select-obrigatorio", id = "CapacidadeSala", style = "display:none" })
                @Html.DropDownListFor(model => model.SqSala, new SelectList(Model.SalasDropDownList.Where(x => x.IndAtivo == 1), "Id", "DsRecursos"), "- Selecione -", new { @class = "select form-control form-control-sm reservas-create select-obrigatorio", id = "DsRecursos", style = "display:none" })
            </div>
            <div id="msgSala" class="alert alert-warning mt-3" style="display:none"><strong>ATENÇÃO!</strong> Sala Departamental - Aguarde e-mail de confirmação da reserva.</div>
            <span asp-validation-for="SqSala" class="text-danger"></span>
        </div>

        <div class="col-12">
            <div class="form-group">
                <input type="hidden" asp-for="IdSolicitante" />
                <span asp-validation-for="IdSolicitante" class="text-danger"></span>
            </div>
        </div>

        <div class="col-12">
            <div class="txtInfo mb-3">
                <strong>
                    <label asp-for="IdSolicitante" class="control-label">Solicitante: </label>
                </strong>
                <select class="select-disabled" asp-for="IdSolicitante" disabled>
                    @foreach (var item in Model.ReservasSolicitanteApi.OrderBy(x => x.NomeSolicitante))
                    {
                        if (Model.IdSolicitante == item.IdSolicitante)
                        {
                            <option id="@item.IdSolicitante" value="@item.IdSolicitante" selected> @item.NomeSolicitante </option>
                        }
                        else
                        {
                            <option id="@item.IdSolicitante" value="@item.IdSolicitante"> @item.NomeSolicitante </option>
                        }
                    }
                </select>
            </div>
        </div>

        <div class="col-12">
            <label asp-for="NrParticipante" class="control-label">Número Participante</label> <span id="msgCapacidade" class="field-validation-error" style="display:none; font-weight:bold;"></span>
            <div class="form-group">
                @{
                    if (TempData["userCriacao"].ToString() == "S")
                    {
                        <input asp-for="NrParticipante" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="NrParticipante" placeholder="" maxlength="4" min="1" required />
                    }
                    else
                    {
                        <input asp-for="NrParticipante" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="NrParticipante" placeholder="" maxlength="4" min="1" required disabled />
                        <input type="hidden" asp-for="NrParticipante" />
                    }
                }
                <span asp-validation-for="NrParticipante" class="text-danger"></span>
            </div>
        </div>
        <div class="col-12">
            <label asp-for="DsReserva" class="control-label">Descrição Reserva</label>
            <div class="form-group">
                @{
                    if (TempData["userCriacao"].ToString() == "S")
                    {
                        <input asp-for="DsReserva" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="DsReserva" placeholder="" maxlength="300" required />
                    }
                    else
                    {
                        <input asp-for="DsReserva" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="DsReserva" placeholder="" maxlength="300" required disabled />
                        <input type="hidden" asp-for="DsReserva" />
                    }
                }
                <span asp-validation-for="DsReserva" class="text-danger"></span>
            </div>
        </div>
        <div class="col-12">
            <label asp-for="DsObservacao" class="control-label">Observação</label>
            <div class="form-group">
                @{
                    if (TempData["userCriacao"].ToString() == "S")
                    {
                        <input asp-for="DsObservacao" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="DsObservacao" placeholder="" maxlength="500" />
                    }
                    else
                    {
                        <input asp-for="DsObservacao" class="form-control form-control-sm reservas-edit reservas-edit-clear" name="DsObservacao" placeholder="" maxlength="500" disabled />
                        <input type="hidden" asp-for="DsObservacao" />
                    }
                }
                <span asp-validation-for="DsObservacao" class="text-danger"></span>
            </div>
        </div>
        <div class="col-12">
            <label asp-for="DtInicio" class="control-label">Data</label>
            <div class="form-group">
                @{
                    if (TempData["userResponsavel"].ToString() == "S" || TempData["userCriacao"].ToString() == "S")
                    {
                        <input class="form-control form-control-sm reservas-edit reservas-edit-clear datepicker data-pt" name="DtInicio" value="@Model.DtInicio" readonly="readonly" required />
                    }
                    else
                    {
                        <input class="form-control form-control-sm reservas-edit reservas-edit-clear datepicker data-pt" name="DtInicio" value="@Model.DtInicio" readonly="readonly" required disabled />
                        <input type="hidden" asp-for="DtInicio" />
                    }
                }
                <span asp-validation-for="DtInicio" class="text-danger"></span>
            </div>
        </div>
        <div class="col-12">
            <label asp-for="HrInicio" class="control-label">Hora Início</label>
            <div class="form-group">
                @{
                    if (TempData["userResponsavel"].ToString() == "S" || TempData["userCriacao"].ToString() == "S")
                    {
                        <input asp-for="HrInicio" class="form-control form-control-sm reservas-edit reservas-edit-clear timepicker" name="HrInicio" placeholder="" readonly="readonly" maxlength="5" required />
                    }
                    else
                    {
                        <input asp-for="HrInicio" class="form-control form-control-sm reservas-edit reservas-edit-clear timepicker" name="HrInicio" placeholder="" readonly="readonly" maxlength="5" required disabled />
                        <input type="hidden" asp-for="HrInicio" />
                    }
                }
                <span asp-validation-for="HrInicio" class="text-danger"></span>
            </div>
        </div>
        <div class="col-12">
            <label asp-for="HrFim" class="control-label">Hora Fim</label>
            <div class="form-group">
                @{
                    if (TempData["userResponsavel"].ToString() == "S" || TempData["userCriacao"].ToString() == "S")
                    {
                        <input asp-for="HrFim" class="form-control form-control-sm reservas-edit reservas-edit-clear timepicker" name="HrFim" placeholder="" readonly="readonly" maxlength="5" required />
                    }
                    else
                    {
                        <input asp-for="HrFim" class="form-control form-control-sm reservas-edit reservas-edit-clear timepicker" name="HrFim" placeholder="" readonly="readonly" maxlength="5" required disabled />
                        <input type="hidden" asp-for="HrFim" />
                    }
                }
                <span asp-validation-for="HrFim" class="text-danger"></span>
            </div>
        </div>

        @*@{
                if (Model.Salas.TpSala == "D")
                {
                    <div class="col-12">
                        <label asp-for="IndValidado" class="control-label">Aprovado</label>
                        <div class="form-group">
                            @{
                                if (TempData["userResponsavel"] != null && TempData["userResponsavel"].ToString() == "S")
                                {
                                    @Html.DropDownListFor(model => model.IndValidado, new[] { new SelectListItem { Text = "- Selecione -", Value = "" }, new SelectListItem { Text = "Não", Value = "N" }, new SelectListItem { Text = "Sim", Value = "S" } }, new { @class = "select form-control reservas-edit select-obrigatorio" })
                                }
                                else
                                {
                                    <input type="hidden" asp-for="IndValidado" />
                                    @Html.DropDownListFor(model => model.IndValidado, new[] { new SelectListItem { Text = "- Selecione -", Value = "" }, new SelectListItem { Text = "Não", Value = "N" }, new SelectListItem { Text = "Sim", Value = "S" } }, new { @class = "select form-control reservas-edit select-obrigatorio", disabled = "disabled" })
                                }
                            }
                            <span asp-validation-for="IndValidado" class="text-danger"></span>
                        </div>
                    </div>
                }
            }*@

        <div class="col-12">
            <label asp-for="IndAtivo" class="control-label">Ativo</label>
            <div class="form-group">
                @{
                    if (TempData["userCriacao"].ToString() == "S")
                    {
                        @Html.DropDownListFor(model => model.IndAtivo, new[] { new SelectListItem { Text = "Sim", Value = "1" }, new SelectListItem { Text = "Não", Value = "0" } }, new { @class = "select form-control form-control-sm reservas-edit select-obrigatorio" })
                    }
                    else
                    {
                        @Html.DropDownListFor(model => model.IndAtivo, new[] { new SelectListItem { Text = "Sim", Value = "1" }, new SelectListItem { Text = "Não", Value = "0" } }, new { @class = "select form-control form-control-sm reservas-edit select-obrigatorio", disabled = "disabled" })
                        <input type="hidden" asp-for="IndAtivo" />
                    }
                }
                <span asp-validation-for="IndAtivo" class="text-danger"></span>
            </div>
        </div>
    </div>
</fieldset>

<fieldset class="fieldset-form mt-3">
    <legend class='mb-2'>Recursos</legend>

    @{
        if (TempData["userCriacao"].ToString() == "S")
        {
            <div class="row">
                <div class="col-12">
                    <div id="msgRecursoExis" class="alert alert-warning" style="display:none">
                        <span id="msgRecursoExistente" class="field-validation-error" style="display:none; font-weight:bold;"></span>
                    </div>
                </div>
                <div class="col-12">
                    <label asp-for="Recursos.SqRecurso" class="control-label">Recurso</label>
                    <div class="input-group mb-3">
                        @Html.DropDownListFor(model => model.Recursos.SqRecurso, new SelectList(Model.RecursosDropDownList.Where(x => x.IndAtivo == 1 && x.IndFixo == "N"), "Id", "Nome"), "- Selecione -", new { @class = "select form-control form-control-sm reservas-create select-obrigatorio id='SqRecurso'", id = "SqRecurso" })
                    </div>
                </div>

                <div class="col-12">
                    <label asp-for="Recursos.QntRecurso" class="control-label">Quantidade</label>
                    <div class="form-group">
                        <input id="QntRecurso" asp-for="Recursos.QntRecurso" class="form-control form-control-sm reservas-create reservas-create-clear" name="Recursos.QntRecurso" placeholder="" maxlength="4" min="1" />
                    </div>
                    <span id="msgRecurso" class="text-danger field-validation-error" style="display:none">Informações não preenchidas</span>
                </div>

                <div class="col-12">
                    <input id="addRecurso" asp-action="Recurso" asp-route-origem="Edit" type="submit" value="Inserir" class="btn btn--primary float-right btn-outline-dark" />
                </div>
            </div>
        }
    }

    <div class="row mt-3">
        <div class="col-md-12">
            <div>
                <table class="table table-striped table-bordered table-hover" style="width:100%">
                    <thead>
                        <tr>
                            <th>Recurso</th>
                            <th>Quantitade</th>
                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        @{
                            if (Model.RecursosTableList != null && Model.RecursosTableList.Count > 0)
                            {
                                foreach (var item in Model.RecursosTableList)
                                {
                                    if (item.IndDeletado == 0)
                                    {
                                        <tr>
                                            <td>@item.DsRecurso</td>
                                            <td>@item.QntRecurso</td>
                                            <td>
                                                @{
                                                    if (TempData["userResponsavel"] != null && TempData["userResponsavel"].ToString() == "S" && TempData["userCriacao"] != null && TempData["userCriacao"].ToString() == "N")
                                                    {
                                                        <button asp-action="DeleteRecurso" asp-route-id="@item.DsRecurso" asp-route-origem="Edit" data-toggle='popover' data-trigger='hover' data-content='Excluir' class='btn btn-outline-dark btn-sm' disabled><i class='fas fa-trash'></i></button>
                                                    }
                                                    else
                                                    {
                                                        <button asp-action="DeleteRecurso" asp-route-id="@item.DsRecurso" asp-route-origem="Edit" data-toggle='popover' data-trigger='hover' data-content='Excluir' class='btn btn-outline-dark btn-sm'><i class='fas fa-trash'></i></button>
                                                    }
                                                }
                                            </td>
                                        </tr>
                                    }
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center">Não há item seleciodo</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</fieldset>

@{
    if (TempData["userResponsavel"].ToString() == "S" || TempData["userCriacao"].ToString() == "S")
    {
        <div class="row">
            <div class="col-12 mt-3">
                <input asp-action="Edit" asp-route-id="@Model.SqReserva" type="submit" value="Salvar" class="btn btn-success float-right" />
            </div>
        </div>
    }
}


@if (Model.TypeView == TypeView.None)
{
    @Html.Raw("</form>")
}


@section Scripts {
    <script src='@cdn/lib/timepicker/timepicker.js'></script>
    <script src="~/js/common.js"></script>

    <script type="text/javascript">
        var SqSala;
        $("#SqRecurso").val('');
        $("#QntRecurso").val('');

        $('#addRecurso').on('click', function (e) {
            if ($('#SqRecurso').val() == "" || $('#QntRecurso').val() == "") {
                $('#msgRecurso').show();
                e.preventDefault();
            }
        });

        var nomeSala = $('#SqSala').find(":selected").text();
        var salaDepartamental = nomeSala.toUpperCase().indexOf("DEPARTAMENTAL") > -1 ? true : false;

        if ($('#SqSala').val() != 0 && salaDepartamental) {
            $('#msgSala').show();
        } else {
            $('#msgSala').hide();
        }

        if ($('#SqSala').val() != 0) {
            $('#msgCapacidade').show();
        } else {
            $('#msgCapacidade').hide();
        }

        if ($('#SqSala').val() != 0) {
            $('#CapacidadeSala').val($('#SqSala').val());
            var capacidade = $('#CapacidadeSala').find(":selected").text();
            var msgCapacidade = ' - A sala selecionada disponibiliza ' + capacidade + ' cadeiras.';
            document.getElementById("msgCapacidade").innerHTML = msgCapacidade;

            $('#DsRecursos').val($('#SqSala').val());
            var dsRecursos = $('#DsRecursos').find(":selected").text();
            if (dsRecursos != "") {
                var msgRecurs = 'A sala selecionada possui o(s) seguinte(s) recurso(s): ' + dsRecursos + '.';
                document.getElementById("msgRecursoExistente").innerHTML = msgRecurs;
                $('#msgRecursoExistente').show();
                $('#msgRecursoExis').show();
            } else {
                $('#msgRecursoExistente').hide();
                $('#msgRecursoExis').hide();
            }
        }

        $('#SqSala').on('click', function () {
            var nomeSala = $('#SqSala').find(":selected").text();
            var salaDepartamental = nomeSala.toUpperCase().indexOf("DEPARTAMENTAL") > -1 ? true : false;

            if ($('#SqSala').val() != 0 && salaDepartamental) {
                $('#msgSala').show();
            } else {
                $('#msgSala').hide();
            }

            if ($('#SqSala').val() != 0) {
                $('#msgCapacidade').show();
            } else {
                $('#msgCapacidade').hide();
            }

            $('#SqSala option:selected').each(function () {
                SqSala = this.value;
                if (SqSala != 0) {
                    $('#CapacidadeSala').val(SqSala);
                    var capacidade = $('#CapacidadeSala').find(":selected").text();
                    var msgCapacidade = ' - A sala selecionada disponibiliza ' + capacidade + ' cadeiras.';
                    document.getElementById("msgCapacidade").innerHTML = msgCapacidade;

                    $('#DsRecursos').val(SqSala);
                    var dsRecursos = $('#DsRecursos').find(":selected").text();
                    if (dsRecursos != "") {
                        var msgRecurs = 'A sala selecionada possui o(s) seguinte(s) recurso(s): ' + dsRecursos + '.';
                        document.getElementById("msgRecursoExistente").innerHTML = msgRecurs;
                        $('#msgRecursoExistente').show();
                        $('#msgRecursoExis').show();
                    } else {
                        $('#msgRecursoExistente').hide();
                        $('#msgRecursoExis').hide();
                    }
                }
            });
        });

        $('#SqRecurso').removeClass('input-validation-error');
        $('#QntRecurso').removeClass('input-validation-error');
        $('#SqRecurso').removeClass('input-validation-error');
    </script>
}
